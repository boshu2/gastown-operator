# Gas Town Operator CI Pipeline
# Multi-stage pipeline with security scanning
#
# Stages:
#   1. Clone - git-clone ClusterTask
#   2. Parallel: go-test, trivy-fs, hadolint
#   3. Build Image - kaniko-build ClusterTask
#   4. Scan Image - trivy-image ClusterTask
#
# Prerequisites:
#   - olympus-ci namespace with ClusterTasks installed
#   - registry-credentials secret for image push
#   - git-credentials secret (if private repo)
#
# Usage:
#   kubectl apply -f deploy/tekton/tasks/ -n olympus-ci
#   kubectl apply -f deploy/tekton/pipeline.yaml -n olympus-ci
#   kubectl create -f deploy/tekton/pipelinerun.yaml -n olympus-ci
---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gastown-operator-ci
  labels:
    app.kubernetes.io/component: pipeline
    app.kubernetes.io/name: gastown-operator
    app.kubernetes.io/part-of: olympus
spec:
  description: |
    CI pipeline for Gas Town Operator - Kubernetes operator for Gas Town multi-agent orchestration.
    Includes security scanning: Trivy (secrets, vulns), Hadolint Dockerfile lint.

  params:
    - name: git-url
      type: string
      description: Git repository URL
    - name: git-revision
      type: string
      default: "main"
      description: Git revision (branch, tag, or SHA)
    - name: image-tag
      type: string
      default: "dev"
      description: Tag for the built image
    - name: registry
      type: string
      description: Container registry URL
    - name: trivy-fail-on
      type: string
      default: "CRITICAL,HIGH"
      description: Trivy severity threshold
    - name: envtest-k8s-version
      type: string
      default: "1.31.x"
      description: Kubernetes version for envtest (must match controller-runtime)

  workspaces:
    - name: source
      description: Workspace for source code
    - name: dockerconfig
      description: Registry credentials for image push
    - name: reports
      description: Workspace for security scan reports

  tasks:
    # =========================================================================
    # Stage 1: Clone
    # =========================================================================
    - name: clone
      taskRef:
        name: git-clone
        kind: ClusterTask
      workspaces:
        - name: output
          workspace: source
      params:
        - name: url
          value: $(params.git-url)
        - name: revision
          value: $(params.git-revision)
        - name: deleteExisting
          value: "true"

    # =========================================================================
    # Stage 2: Parallel - Tests and Security Scans
    # =========================================================================

    # 2a. Go unit tests with envtest
    - name: go-test
      taskRef:
        name: gastown-operator-go-test
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: source
      params:
        - name: packages
          value: "./internal/..."
        - name: envtest-k8s-version
          value: $(params.envtest-k8s-version)

    # 2b. Trivy filesystem scan - secrets and misconfigs
    - name: scan-secrets
      taskRef:
        name: jren-trivy-fs
        kind: ClusterTask
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: source
      params:
        - name: scanners
          value: "secret,misconfig"
        - name: severity
          value: "LOW,MEDIUM,HIGH,CRITICAL"

    # 2c. Hadolint - Dockerfile best practices
    - name: lint-dockerfile
      taskRef:
        name: jren-hadolint-scan
        kind: ClusterTask
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: source
      params:
        - name: dockerfile-path
          value: "Dockerfile"

    # =========================================================================
    # Stage 3: Build Image
    # =========================================================================

    - name: build-operator
      taskRef:
        name: jren-kaniko-build
        kind: ClusterTask
      runAfter:
        - go-test
        - scan-secrets
        - lint-dockerfile
      workspaces:
        - name: source
          workspace: source
        - name: dockerconfig
          workspace: dockerconfig
      params:
        - name: IMAGE
          value: "$(params.registry)/gastown-operator:$(params.image-tag)"
        - name: DOCKERFILE
          value: "Dockerfile"
        - name: CONTEXT
          value: "."
        - name: EXTRA_ARGS
          value:
            - "--build-arg=VERSION=$(params.image-tag)"

    # =========================================================================
    # Stage 4: Image Security Scan
    # =========================================================================

    - name: scan-image
      taskRef:
        name: jren-trivy-image
        kind: ClusterTask
      runAfter:
        - build-operator
      workspaces:
        - name: reports
          workspace: reports
        - name: dockerconfig
          workspace: dockerconfig
      params:
        - name: IMAGE
          value: "$(params.registry)/gastown-operator:$(params.image-tag)"
        - name: SEVERITY
          value: "$(params.trivy-fail-on)"

    # =========================================================================
    # Stage 5: Mirror to GHCR (Public Registry)
    # =========================================================================

    - name: mirror-to-ghcr
      taskRef:
        name: jren-skopeo-copy
        kind: ClusterTask
      runAfter:
        - scan-image
      params:
        - name: srcImageURL
          value: "docker://$(params.registry)/gastown-operator:$(params.image-tag)"
        - name: destImageURL
          value: "docker://ghcr.io/boshu2/gastown-operator:$(params.image-tag)"
      workspaces:
        - name: dockerconfig
          workspace: dockerconfig

  # ===========================================================================
  # Finally: Summary Report
  # ===========================================================================
  finally:
    - name: pipeline-summary
      params:
        - name: registry
          value: $(params.registry)
        - name: image-tag
          value: $(params.image-tag)
      taskSpec:
        params:
          - name: registry
            type: string
          - name: image-tag
            type: string
        steps:
          - name: summary
            image: dprusocplvjmp01.deepsky.lab:5000/library/alpine:3.19
            script: |
              #!/bin/sh
              echo "========================================"
              echo "  Gas Town Operator CI Pipeline Complete"
              echo "========================================"
              echo ""
              echo "Images pushed to:"
              echo "  - $(params.registry)/gastown-operator:$(params.image-tag)"
              echo "  - ghcr.io/boshu2/gastown-operator:$(params.image-tag)"
              echo ""
              echo "Security scans completed:"
              echo "  - Trivy filesystem scan (secrets, misconfigs)"
              echo "  - Hadolint Dockerfile lint"
              echo "  - Trivy image vulnerability scan"
              echo ""
              echo "========================================"
