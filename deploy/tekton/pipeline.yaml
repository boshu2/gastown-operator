# Gas Town Operator CI Pipeline
# Multi-stage pipeline with comprehensive security scanning
#
# Stages:
#   1. Clone - git-clone ClusterTask
#   2. Parallel: go-test, govulncheck, gosec, gitleaks, trivy-fs, hadolint, vibe-prescan
#   3. Build gt CLI (pre-build for Dockerfile)
#   4. Build Image - kaniko-build ClusterTask
#   5. Scan Image - trivy-image ClusterTask
#   6. Generate SBOM - syft
#   7. Sign Image - cosign
#   8. Athena knowledge persistence (finally block)
#
# NOTE: GHCR push (image + helm) moved to GitLab CI to run AFTER e2e tests.
# This ensures broken releases are never published to the public registry.
# See .gitlab-ci.yml for the complete flow.
#
# Prerequisites:
#   - olympus-ci namespace with ClusterTasks installed
#   - registry-credentials secret for image push
#   - git-credentials secret (if private repo)
#
# Usage:
#   kubectl apply -f deploy/tekton/tasks/ -n olympus-ci
#   kubectl apply -f deploy/tekton/pipeline.yaml -n olympus-ci
#   kubectl create -f deploy/tekton/pipelinerun.yaml -n olympus-ci
---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gastown-operator-ci
  labels:
    app.kubernetes.io/component: pipeline
    app.kubernetes.io/name: gastown-operator
    app.kubernetes.io/part-of: olympus
spec:
  description: |
    CI pipeline for Gas Town Operator - Kubernetes operator for Gas Town multi-agent orchestration.
    Includes comprehensive security scanning: govulncheck, gosec, gitleaks, Trivy, Hadolint.
    Generates SBOM and signs images with Cosign.

  params:
    # Git parameters
    - name: git-url
      type: string
      description: Git repository URL
    - name: git-revision
      type: string
      default: "main"
      description: Git revision (branch, tag, or SHA)

    # Image parameters
    - name: image-tag
      type: string
      default: "dev"
      description: Tag for the built image
    - name: dockerfile
      type: string
      default: "Dockerfile"
      description: Path to Dockerfile (Dockerfile for community, Dockerfile.fips for enterprise)

    # Registry parameters (portable)
    - name: registry
      type: string
      description: Primary container registry URL (internal)
    - name: ghcr-registry
      type: string
      default: "ghcr.io/boshu2"
      description: GHCR registry for public mirroring

    # Gastown CLI parameters
    - name: gastown-ref
      type: string
      default: "main"
      description: Git ref for gastown CLI (tag/branch/SHA)

    # Security parameters
    - name: trivy-fail-on
      type: string
      default: "CRITICAL,HIGH"
      description: Trivy severity threshold
    - name: gosec-severity
      type: string
      default: "HIGH,CRITICAL"
      description: Gosec severity threshold
    - name: fail-on-vuln
      type: string
      default: "true"
      description: Whether to fail on vulnerabilities

    # Build parameters
    - name: envtest-k8s-version
      type: string
      default: "1.31.x"
      description: Kubernetes version for envtest (must match controller-runtime)

    # Signing parameters
    - name: cosign-signing-mode
      type: string
      default: "keyless"
      description: Cosign signing mode (keyless or key-based)

    # Vibe quality gate parameters
    - name: vibe-fail-on
      type: string
      default: "HIGH"
      description: Vibe prescan severity threshold (CRITICAL, HIGH, MEDIUM)

  workspaces:
    - name: source
      description: Workspace for source code
    - name: dockerconfig
      description: Registry credentials for image push
    - name: reports
      description: Workspace for security scan reports

  tasks:
    # =========================================================================
    # Stage 1: Clone
    # =========================================================================
    - name: clone
      taskRef:
        name: git-clone
        kind: ClusterTask
      timeout: 5m
      workspaces:
        - name: output
          workspace: source
      params:
        - name: url
          value: $(params.git-url)
        - name: revision
          value: $(params.git-revision)
        - name: deleteExisting
          value: "true"

    # =========================================================================
    # Stage 2: Parallel - Tests and Security Scans
    # =========================================================================

    # 2a. Go unit tests with envtest
    - name: go-test
      taskRef:
        name: gastown-operator-go-test
      timeout: 15m
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: source
      params:
        - name: packages
          value: "./internal/..."
        - name: envtest-k8s-version
          value: $(params.envtest-k8s-version)

    # 2b. Go vulnerability check
    - name: govulncheck
      taskRef:
        name: gastown-operator-govulncheck
      timeout: 10m
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: source
      params:
        - name: packages
          value: "./..."
        - name: fail-on-vuln
          value: $(params.fail-on-vuln)

    # 2c. Go security static analysis
    - name: gosec
      taskRef:
        name: gastown-operator-gosec
      timeout: 10m
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: source
      params:
        - name: severity
          value: $(params.gosec-severity)

    # 2d. Secret detection
    - name: gitleaks
      taskRef:
        name: gastown-operator-gitleaks
      timeout: 5m
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: source

    # 2e. Trivy filesystem scan - secrets and misconfigs
    - name: scan-secrets
      taskRef:
        name: jren-trivy-fs
        kind: ClusterTask
      timeout: 10m
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: source
      params:
        - name: scanners
          value: "secret,misconfig"
        - name: severity
          value: "LOW,MEDIUM,HIGH,CRITICAL"

    # 2f. Hadolint - Dockerfile best practices
    - name: lint-dockerfile
      taskRef:
        name: jren-hadolint-scan
        kind: ClusterTask
      timeout: 5m
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: source
      params:
        - name: dockerfile-path
          value: "$(params.dockerfile)"

    # 2g. Vibe prescan - Fast static quality validation
    - name: vibe-prescan
      taskRef:
        name: gastown-operator-vibe-prescan
      timeout: 10m
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: source
      params:
        - name: target
          value: "all"
        - name: fail-on
          value: $(params.vibe-fail-on)

    # =========================================================================
    # Stage 3: Build gt CLI (pre-build for Dockerfile)
    # =========================================================================

    - name: build-gt-cli
      taskRef:
        name: gastown-operator-build-gt-cli
      timeout: 10m
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: source
      params:
        - name: gastown-ref
          value: $(params.gastown-ref)

    # =========================================================================
    # Stage 4: Build Image
    # =========================================================================

    - name: build-operator
      taskRef:
        name: jren-kaniko-build
        kind: ClusterTask
      timeout: 20m
      runAfter:
        - go-test
        - govulncheck
        - gosec
        - gitleaks
        - scan-secrets
        - lint-dockerfile
        - vibe-prescan
        - build-gt-cli
      workspaces:
        - name: source
          workspace: source
        - name: dockerconfig
          workspace: dockerconfig
      params:
        - name: IMAGE
          value: "$(params.registry)/gastown-operator:$(params.image-tag)"
        - name: DOCKERFILE
          value: "$(params.dockerfile)"
        - name: CONTEXT
          value: "."
        - name: BUILD_EXTRA_ARGS
          value: "--build-arg=VERSION=$(params.image-tag) --build-arg=GO_IMAGE=$(params.registry)/projectquay/golang:1.24"

    # =========================================================================
    # Stage 5: Image Security Scan
    # =========================================================================

    - name: scan-image
      taskRef:
        name: jren-trivy-image
        kind: ClusterTask
      timeout: 15m
      runAfter:
        - build-operator
      workspaces:
        - name: reports
          workspace: reports
        - name: dockerconfig
          workspace: dockerconfig
      params:
        - name: IMAGE
          value: "$(params.registry)/gastown-operator:$(params.image-tag)"
        - name: SEVERITY
          value: "$(params.trivy-fail-on)"

    # =========================================================================
    # Stage 6: Generate SBOM
    # =========================================================================

    - name: generate-sbom
      taskRef:
        name: gastown-operator-syft-sbom
      timeout: 10m
      runAfter:
        - scan-image
      workspaces:
        - name: source
          workspace: source
        - name: dockerconfig
          workspace: dockerconfig
      params:
        - name: image
          value: "$(params.registry)/gastown-operator:$(params.image-tag)"
        - name: output-format
          value: "spdx-json"

    # =========================================================================
    # Stage 7: Sign Image
    # =========================================================================

    - name: sign-image
      taskRef:
        name: gastown-operator-cosign-sign
      timeout: 5m
      runAfter:
        - generate-sbom
      workspaces:
        - name: source
          workspace: source
        - name: dockerconfig
          workspace: dockerconfig
      params:
        - name: image
          value: "$(params.registry)/gastown-operator:$(params.image-tag)"
        - name: signing-mode
          value: $(params.cosign-signing-mode)
        - name: sbom-path
          value: "$(workspaces.source.path)/sbom.spdx-json.json"

    # =========================================================================
    # NOTE: GHCR push moved to GitLab CI (after e2e tests pass)
    # =========================================================================
    # The mirror-to-ghcr and helm-push tasks have been removed from Tekton.
    # Images stay in internal registry until e2e tests pass in GitLab CI.
    # This prevents publishing broken releases to the public registry.
    #
    # Flow:
    #   Tekton: build → sign → push to internal registry
    #   GitLab: e2e tests → push:ghcr → push:helm → sync:github
    # =========================================================================

  # ===========================================================================
  # Finally: Summary Report and Knowledge Persistence
  # ===========================================================================
  finally:
    # Store pipeline results in Athena for knowledge persistence
    - name: athena-persist
      taskRef:
        name: gastown-operator-athena-persist
      timeout: 2m
      workspaces:
        - name: source
          workspace: source
      params:
        - name: version
          value: $(params.image-tag)
        - name: memory-type
          value: "release"
        - name: pipeline-status
          value: "$(tasks.status)"

    # Print pipeline summary
    - name: pipeline-summary
      params:
        - name: registry
          value: $(params.registry)
        - name: ghcr-registry
          value: $(params.ghcr-registry)
        - name: image-tag
          value: $(params.image-tag)
      taskSpec:
        params:
          - name: registry
            type: string
          - name: ghcr-registry
            type: string
          - name: image-tag
            type: string
        steps:
          - name: summary
            image: dprusocplvjmp01.deepsky.lab:5000/library/alpine:3.19
            script: |
              #!/bin/sh
              echo "========================================"
              echo "  Gas Town Operator CI Pipeline Complete"
              echo "========================================"
              echo ""
              echo "Image built and pushed to internal registry:"
              echo "  - $(params.registry)/gastown-operator:$(params.image-tag)"
              echo ""
              echo "Security scans completed:"
              echo "  - govulncheck (Go dependency vulnerabilities)"
              echo "  - gosec (Go security static analysis)"
              echo "  - gitleaks (secret detection)"
              echo "  - Trivy filesystem scan (secrets, misconfigs)"
              echo "  - Hadolint Dockerfile lint"
              echo "  - Vibe prescan (quality gate)"
              echo "  - Trivy image vulnerability scan"
              echo ""
              echo "Supply chain security:"
              echo "  - SBOM generated (SPDX JSON)"
              echo "  - Image signed with Cosign"
              echo ""
              echo "Next steps (handled by GitLab CI):"
              echo "  1. E2E tests (upgrade + fresh install)"
              echo "  2. Push to GHCR (after tests pass)"
              echo "  3. Push Helm chart to GHCR"
              echo "  4. Create GitHub release"
              echo ""
              echo "========================================"
