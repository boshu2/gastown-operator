# Labyrinth Operator CI Pipeline
# Multi-stage pipeline with security scanning
#
# Stages:
#   1. Clone - git-clone ClusterTask
#   2. Parallel: go-test, trivy-fs, hadolint
#   3. Build Image - kaniko-build ClusterTask
#   4. Scan Image - trivy-image ClusterTask
#
# Prerequisites:
#   - olympus-ci namespace with ClusterTasks installed
#   - registry-credentials secret for image push
#   - git-credentials secret (if private repo)
#
# Usage:
#   kubectl apply -f deploy/tekton/tasks/ -n olympus-ci
#   kubectl apply -f deploy/tekton/pipeline.yaml -n olympus-ci
#   kubectl create -f deploy/tekton/pipelinerun.yaml -n olympus-ci
---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: labyrinth-ci
  namespace: olympus-ci
  labels:
    app.kubernetes.io/component: pipeline
    app.kubernetes.io/name: labyrinth
    app.kubernetes.io/part-of: olympus
spec:
  description: |
    CI pipeline for Labyrinth - Kubernetes operator for Gas Town multi-agent orchestration.
    Includes security scanning: Trivy (secrets, vulns), Hadolint Dockerfile lint.

  params:
    - name: git-url
      type: string
      description: Git repository URL
    - name: git-revision
      type: string
      default: "main"
      description: Git revision (branch, tag, or SHA)
    - name: image-tag
      type: string
      default: "dev"
      description: Tag for the built image
    - name: registry
      type: string
      description: Container registry URL
    - name: trivy-fail-on
      type: string
      default: "CRITICAL,HIGH"
      description: Trivy severity threshold
    - name: envtest-k8s-version
      type: string
      default: "1.31.x"
      description: Kubernetes version for envtest (must match controller-runtime)

  workspaces:
    - name: source
      description: Workspace for source code
    - name: dockerconfig
      description: Registry credentials for image push
    - name: reports
      description: Workspace for security scan reports
    - name: git-credentials
      description: Git basic-auth credentials for private repos
      optional: true

  tasks:
    # =========================================================================
    # Stage 1: Clone
    # =========================================================================
    - name: clone
      taskRef:
        name: git-clone
        kind: ClusterTask
      workspaces:
        - name: output
          workspace: source
        - name: basic-auth
          workspace: git-credentials
      params:
        - name: url
          value: $(params.git-url)
        - name: revision
          value: $(params.git-revision)
        - name: deleteExisting
          value: "true"

    # =========================================================================
    # Stage 2: Parallel - Tests and Security Scans
    # =========================================================================

    # 2a. Go unit tests with envtest
    - name: go-test
      taskRef:
        name: labyrinth-go-test
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: source
      params:
        - name: packages
          value: "./internal/..."
        - name: envtest-k8s-version
          value: $(params.envtest-k8s-version)

    # 2b. Trivy filesystem scan - secrets and misconfigs
    - name: scan-secrets
      taskRef:
        name: jren-trivy-fs
        kind: ClusterTask
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: source
        - name: reports
          workspace: reports
      params:
        - name: SCANNERS
          value: "vuln,secret,misconfig"
        - name: SEVERITY
          value: "MEDIUM,HIGH,CRITICAL"
        - name: FAIL_ON
          value: "CRITICAL"

    # 2c. Hadolint - Dockerfile best practices
    - name: lint-dockerfile
      taskRef:
        name: jren-hadolint-scan
        kind: ClusterTask
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: source
      params:
        - name: DOCKERFILE
          value: "Dockerfile"
        - name: FAILURE_THRESHOLD
          value: "error"

    # =========================================================================
    # Stage 3: Build Image
    # =========================================================================

    - name: build-operator
      taskRef:
        name: jren-kaniko-build
        kind: ClusterTask
      runAfter:
        - go-test
        - scan-secrets
        - lint-dockerfile
      workspaces:
        - name: source
          workspace: source
        - name: dockerconfig
          workspace: dockerconfig
      params:
        - name: IMAGE
          value: "$(params.registry)/labyrinth:$(params.image-tag)"
        - name: DOCKERFILE
          value: "Dockerfile"
        - name: CONTEXT
          value: "."
        - name: BUILD_EXTRA_ARGS
          value: "--build-arg=VERSION=$(params.image-tag) --build-arg=GO_IMAGE=dprusocplvjmp01.deepsky.lab:5000/library/golang:1.24-alpine --build-arg=RUNTIME_IMAGE=dprusocplvjmp01.deepsky.lab:5000/distroless/static:nonroot"

    # =========================================================================
    # Stage 4: Image Security Scan
    # =========================================================================

    - name: scan-image
      taskRef:
        name: jren-trivy-image
        kind: ClusterTask
      runAfter:
        - build-operator
      workspaces:
        - name: reports
          workspace: reports
        - name: dockerconfig
          workspace: dockerconfig
      params:
        - name: IMAGE
          value: "$(params.registry)/labyrinth:$(params.image-tag)"
        - name: SEVERITY
          value: "MEDIUM,HIGH,CRITICAL"
        - name: FAIL_ON
          value: "$(params.trivy-fail-on)"

  # ===========================================================================
  # Finally: Summary Report
  # ===========================================================================
  finally:
    - name: pipeline-summary
      params:
        - name: registry
          value: $(params.registry)
        - name: image-tag
          value: $(params.image-tag)
      taskSpec:
        params:
          - name: registry
            type: string
          - name: image-tag
            type: string
        steps:
          - name: summary
            image: dprusocplvjmp01.deepsky.lab:5000/library/alpine:3.19
            script: |
              #!/bin/sh
              echo "========================================"
              echo "  Labyrinth CI Pipeline Complete"
              echo "========================================"
              echo ""
              echo "Image built and scanned:"
              echo "  - $(params.registry)/labyrinth:$(params.image-tag)"
              echo ""
              echo "Security scans completed:"
              echo "  - Trivy filesystem scan (secrets, misconfigs)"
              echo "  - Hadolint Dockerfile lint"
              echo "  - Trivy image vulnerability scan"
              echo ""
              echo "========================================"
