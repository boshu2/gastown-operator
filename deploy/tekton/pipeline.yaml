# gastown-operator CI Pipeline
# Multi-stage pipeline with security scanning
#
# Stages:
#   1. Clone - git-clone ClusterTask
#   2. Parallel: go-test (local Task), trivy-fs, hadolint
#   3. Build gt CLI - build-gt-cli Task
#   4. Build Image - kaniko-build ClusterTask
#   5. Scan Image - trivy-image ClusterTask (vulnerability scan + SBOM)
#
# ClusterTask Requirements:
#   This pipeline uses common Tekton ClusterTasks. Install them from:
#   - https://hub.tekton.dev/tekton/task/git-clone
#   - https://hub.tekton.dev/tekton/task/kaniko
#   - https://hub.tekton.dev/tekton/task/trivy-scanner (or similar)
#   - https://hub.tekton.dev/tekton/task/hadolint
#
# Usage:
#   kubectl apply -f deploy/tekton/tasks/ -n <YOUR_NAMESPACE>
#   kubectl apply -f deploy/tekton/pipeline.yaml -n <YOUR_NAMESPACE>
#   kubectl create -f deploy/tekton/pipelinerun.yaml -n <YOUR_NAMESPACE>
---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gastown-operator-ci
  # CUSTOMIZE: Set to your CI namespace
  namespace: gastown-ci
  labels:
    app.kubernetes.io/component: pipeline
    app.kubernetes.io/name: gastown-operator
spec:
  description: |
    CI pipeline for gastown-operator - Kubernetes operator for Gas Town execution.
    Includes security scanning: Trivy (secrets, vulns, SBOM), Hadolint Dockerfile lint.

  params:
    - name: git-url
      type: string
      default: "https://github.com/boshu2/gastown-operator.git"
    - name: git-revision
      type: string
      default: "main"
    - name: image-tag
      type: string
      default: "dev"
    - name: registry
      type: string
      # CUSTOMIZE: Your container registry
      default: "ghcr.io/boshu2"
    # Security scanning parameters
    - name: trivy-fail-on
      description: Trivy severity threshold (CRITICAL, HIGH, MEDIUM, LOW)
      type: string
      default: "CRITICAL,HIGH"
    - name: generate-sbom
      description: Generate SBOM in CycloneDX format
      type: string
      default: "true"

  workspaces:
    - name: source
    - name: dockerconfig
    - name: reports
      description: Workspace for security scan reports
      optional: true

  tasks:
    # =========================================================================
    # Stage 1: Clone
    # =========================================================================
    - name: clone
      taskRef:
        name: git-clone
        kind: ClusterTask
      workspaces:
        - name: output
          workspace: source
      params:
        - name: url
          value: $(params.git-url)
        - name: revision
          value: $(params.git-revision)
        - name: deleteExisting
          value: "true"

    # =========================================================================
    # Stage 2: Parallel - Tests and Security Scans
    # =========================================================================

    # 2a. Go unit tests with envtest
    - name: go-test
      taskRef:
        name: go-test-gastown
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: source
      params:
        - name: packages
          value: "./pkg/... ./internal/..."
        - name: envtest-k8s-version
          value: "1.31.x"

    # 2b. Trivy filesystem scan - secrets and misconfigs
    # NOTE: Replace with your trivy ClusterTask name
    - name: scan-secrets
      taskRef:
        name: trivy-scanner
        kind: ClusterTask
      runAfter:
        - clone
      workspaces:
        - name: manifest-dir
          workspace: source
      params:
        - name: ARGS
          value:
            - "fs"
            - "--scanners=secret,misconfig"
            - "--severity=LOW,MEDIUM,HIGH,CRITICAL"
            - "."

    # 2c. Hadolint - Dockerfile best practices
    - name: lint-dockerfile
      taskRef:
        name: hadolint
        kind: ClusterTask
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: source
      params:
        - name: dockerfile-path
          value: "Dockerfile.tekton"

    # =========================================================================
    # Stage 3: Pre-build gt CLI (needed for operator image)
    # =========================================================================

    # 3a. Build gt CLI from gastown source
    - name: build-gt-cli
      taskRef:
        name: build-gt-cli
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: source
      params:
        - name: gastown-url
          value: "https://github.com/steveyegge/gastown.git"
        - name: gastown-revision
          value: "main"

    # =========================================================================
    # Stage 4: Build Image
    # =========================================================================

    - name: build-operator
      taskRef:
        name: kaniko
        kind: ClusterTask
      runAfter:
        - go-test
        - scan-secrets
        - lint-dockerfile
        - build-gt-cli
      workspaces:
        - name: source
          workspace: source
        - name: dockerconfig
          workspace: dockerconfig
      params:
        - name: IMAGE
          value: "$(params.registry)/gastown-operator:$(params.image-tag)"
        - name: DOCKERFILE
          value: "Dockerfile.tekton"
        - name: CONTEXT
          value: "."

    # =========================================================================
    # Stage 5: Image Security Scan + SBOM
    # =========================================================================

    - name: scan-image
      taskRef:
        name: trivy-scanner
        kind: ClusterTask
      runAfter:
        - build-operator
      workspaces:
        - name: manifest-dir
          workspace: source
      params:
        - name: ARGS
          value:
            - "image"
            - "--severity=$(params.trivy-fail-on)"
            - "$(params.registry)/gastown-operator:$(params.image-tag)"

  # ===========================================================================
  # Finally: Summary Report
  # ===========================================================================
  finally:
    - name: pipeline-summary
      params:
        - name: registry
          value: $(params.registry)
        - name: image-tag
          value: $(params.image-tag)
      taskSpec:
        params:
          - name: registry
            type: string
          - name: image-tag
            type: string
        steps:
          - name: summary
            image: alpine:3.19
            script: |
              #!/bin/sh
              echo "========================================"
              echo "  gastown-operator CI Pipeline Complete"
              echo "========================================"
              echo ""
              echo "Image built and scanned:"
              echo "  - $(params.registry)/gastown-operator:$(params.image-tag)"
              echo ""
              echo "Security scans completed:"
              echo "  - Trivy filesystem scan (secrets, misconfigs)"
              echo "  - Hadolint Dockerfile lint"
              echo "  - Trivy image vulnerability scan"
              echo "  - SBOM generation (CycloneDX)"
              echo ""
              echo "========================================"
