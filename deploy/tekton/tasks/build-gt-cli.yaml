# Build gt CLI Task
# Clones gastown and builds the gt binary for use in the operator image
#
# This Task builds gt CLI from source. The built binary is placed in the
# source workspace for the Kaniko build to COPY into the final image.
#
# Usage:
#   kubectl apply -f deploy/tekton/tasks/build-gt-cli.yaml -n <YOUR_NAMESPACE>
---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: build-gt-cli
  # CUSTOMIZE: Set to your CI namespace
  namespace: gastown-ci
  labels:
    app.kubernetes.io/component: task
    app.kubernetes.io/name: gastown-operator
spec:
  description: Build gt CLI from gastown source for operator image
  workspaces:
    - name: source
  params:
    - name: gastown-url
      type: string
      # Official gastown repository
      default: "https://github.com/steveyegge/gastown.git"
      description: URL of the gastown repository
    - name: gastown-revision
      type: string
      default: "main"
      description: Git branch/tag to build from
    - name: go-version
      type: string
      default: "1.24"
      description: Go version to use for build
  results:
    - name: gt-path
      description: Path to the built gt binary
  steps:
    - name: build-gt
      image: golang:$(params.go-version)
      workingDir: $(workspaces.source.path)
      env:
        - name: GOCACHE
          value: "/workspace/source/.cache/go-build"
        - name: GOMODCACHE
          value: "/workspace/source/.cache/go-mod"
      script: |
        #!/bin/bash
        set -e

        echo "========================================"
        echo "  Building gt CLI from gastown"
        echo "========================================"
        echo ""
        echo "Go version: $(go version)"
        echo "Gastown: $(params.gastown-url)@$(params.gastown-revision)"
        echo ""

        # Create temp directory for gastown clone
        mkdir -p /tmp/gastown
        cd /tmp/gastown

        # Clone gastown
        echo "Cloning gastown..."
        git clone --depth 1 --branch $(params.gastown-revision) \
          $(params.gastown-url) .

        # Download dependencies
        echo "Downloading dependencies..."
        go mod download

        # Build gt CLI
        echo "Building gt CLI..."
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
          go build -trimpath -ldflags="-s -w" -o gt ./cmd/gt

        # Copy to source workspace for Kaniko
        mkdir -p $(workspaces.source.path)/bin
        cp gt $(workspaces.source.path)/bin/gt
        chmod +x $(workspaces.source.path)/bin/gt

        # Write result
        echo -n "bin/gt" > $(results.gt-path.path)

        echo ""
        echo "========================================"
        echo "  gt CLI built successfully"
        echo "  Location: $(workspaces.source.path)/bin/gt"
        echo "========================================"

        # Verify
        $(workspaces.source.path)/bin/gt version || echo "gt version check skipped (may need runtime deps)"
