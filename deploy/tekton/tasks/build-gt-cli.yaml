# Build gt CLI Task
# Clones daedalus and builds the gt binary for use in the operator image
#
# This Task builds gt CLI from source since the daedalus repo is private.
# The built binary is placed in the source workspace for the Kaniko build.
#
# Usage:
#   oc apply -f deploy/tekton/tasks/build-gt-cli.yaml -n olympus-ci
---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: build-gt-cli
  namespace: olympus-ci
  labels:
    app.kubernetes.io/component: task
    app.kubernetes.io/name: gastown-operator
spec:
  description: Build gt CLI from daedalus source for operator image
  workspaces:
    - name: source
  params:
    - name: daedalus-url
      type: string
      # Use public GitHub fork which has our patches and doesn't require auth
      # The olympus/daedalus requires GitLab auth which complicates CI
      default: "https://github.com/boshu2/gastown.git"
      description: URL of the daedalus/gastown repository (public fork)
    - name: daedalus-revision
      type: string
      default: "main"
      description: Git branch/tag to build from
    - name: go-version
      type: string
      default: "1.24"
      description: Go version to use for build
  results:
    - name: gt-path
      description: Path to the built gt binary
  steps:
    - name: build-gt
      image: quay.io/projectquay/golang:$(params.go-version)
      workingDir: $(workspaces.source.path)
      env:
        - name: GOCACHE
          value: "/workspace/source/.cache/go-build"
        - name: GOMODCACHE
          value: "/workspace/source/.cache/go-mod"
      script: |
        #!/bin/bash
        set -e

        echo "========================================"
        echo "  Building gt CLI from daedalus"
        echo "========================================"
        echo ""
        echo "Go version: $(go version)"
        echo "Daedalus: $(params.daedalus-url)@$(params.daedalus-revision)"
        echo ""

        # Create temp directory for daedalus clone
        mkdir -p /tmp/daedalus
        cd /tmp/daedalus

        # Clone daedalus - Tekton git-credentials should be available
        echo "Cloning daedalus..."
        git clone --depth 1 --branch $(params.daedalus-revision) \
          $(params.daedalus-url) .

        # Download dependencies first using local go.mod
        # IMPORTANT: Use GOPROXY=direct to avoid pulling broken upstream from proxy cache
        echo "Downloading dependencies (direct, no proxy cache)..."
        export GOPROXY=direct
        go mod download

        # Build gt CLI from local source
        echo "Building gt CLI..."
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
          go build -trimpath -ldflags="-s -w" -o gt ./cmd/gt

        # Copy to source workspace for Kaniko
        mkdir -p $(workspaces.source.path)/bin
        cp gt $(workspaces.source.path)/bin/gt
        chmod +x $(workspaces.source.path)/bin/gt

        # Write result
        echo -n "bin/gt" > $(results.gt-path.path)

        echo ""
        echo "========================================"
        echo "  gt CLI built successfully"
        echo "  Location: $(workspaces.source.path)/bin/gt"
        echo "========================================"

        # Verify
        $(workspaces.source.path)/bin/gt version || echo "gt version check skipped (may need runtime deps)"
