# Labyrinth Go Unit Test Task
# Runs controller unit tests with envtest (etcd + kube-apiserver)
#
# This is a namespace-local Task (not ClusterTask) because:
# - envtest binaries must be downloaded at runtime
# - controller-runtime version must match (release-0.22 for v0.22.x)
#
# Version Matrix:
#   controller-runtime | envtest K8s version
#   v0.22.x           | 1.31.x
#   v0.21.x           | 1.30.x
#   v0.20.x           | 1.29.x
#
# Usage:
#   kubectl apply -f deploy/tekton/tasks/go-test.yaml -n olympus-ci
---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: gastown-operator-go-test
  labels:
    app.kubernetes.io/component: task
    app.kubernetes.io/name: gastown-operator
    app.kubernetes.io/part-of: olympus
spec:
  description: Run Go unit tests for Labyrinth operator with envtest binaries
  workspaces:
    - name: source
  params:
    - name: packages
      type: string
      default: "./internal/..."
      description: Go packages to test
    - name: go-version
      type: string
      default: "1.24"
      description: Go version to use
    - name: envtest-k8s-version
      type: string
      default: "1.31.x"
      description: Kubernetes version for envtest binaries
  results:
    - name: test-status
      description: Test execution status (passed/failed)
    - name: coverage
      description: Test coverage percentage
  steps:
    - name: setup-and-test
      image: golang:$(params.go-version)
      workingDir: $(workspaces.source.path)
      computeResources:
        requests:
          memory: 1Gi
          cpu: 500m
        limits:
          memory: 2Gi
          cpu: "2"
      env:
        - name: GOCACHE
          value: "/workspace/source/.cache/go-build"
        - name: GOMODCACHE
          value: "/workspace/source/.cache/go-mod"
      script: |
        #!/bin/bash
        set -e

        echo "========================================"
        echo "  Gas Town Operator Go Unit Tests"
        echo "========================================"
        echo ""
        echo "Go version: $(go version)"
        echo "Packages: $(params.packages)"
        echo "Envtest K8s: $(params.envtest-k8s-version)"
        echo ""

        # Install envtest setup tool
        # Pin to release-0.22 branch (matches controller-runtime v0.22.x in go.mod)
        echo "Installing setup-envtest..."
        go install sigs.k8s.io/controller-runtime/tools/setup-envtest@release-0.22
        export PATH="$(go env GOPATH)/bin:$PATH"

        # Download and configure envtest binaries
        echo "Setting up envtest binaries..."
        export KUBEBUILDER_ASSETS="$(setup-envtest use $(params.envtest-k8s-version) -p path)"
        echo "KUBEBUILDER_ASSETS=$KUBEBUILDER_ASSETS"
        echo ""

        # Download dependencies
        echo "Downloading Go modules..."
        go mod download

        # Run tests
        echo ""
        echo "Running tests..."
        echo "----------------------------------------"

        if go test $(params.packages) -v -coverprofile=coverage.out 2>&1 | tee /tmp/test-output.txt; then
          echo "passed" > $(results.test-status.path)
          echo ""
          echo "========================================"
          echo "  Tests PASSED"
          echo "========================================"
        else
          echo "failed" > $(results.test-status.path)
          echo ""
          echo "========================================"
          echo "  Tests FAILED"
          echo "========================================"
          exit 1
        fi

        # Extract and save coverage
        echo ""
        echo "Coverage summary:"
        COVERAGE=$(go tool cover -func=coverage.out | tail -1 | awk '{print $3}')
        echo "Total coverage: $COVERAGE"
        echo "$COVERAGE" > $(results.coverage.path)
