# gastown-operator CI PipelineRun
# Creates a new pipeline execution for building and scanning the operator
#
# Prerequisites:
#   1. Apply the Tasks:
#      kubectl apply -f deploy/tekton/tasks/ -n <YOUR_NAMESPACE>
#
#   2. Apply the Pipeline:
#      kubectl apply -f deploy/tekton/pipeline.yaml -n <YOUR_NAMESPACE>
#
#   3. Create registry credentials:
#      kubectl create secret docker-registry registry-credentials \
#        --docker-server=<YOUR_REGISTRY> \
#        --docker-username=xxx --docker-password=xxx -n <YOUR_NAMESPACE>
#
# Usage:
#   kubectl create -f deploy/tekton/pipelinerun.yaml
#
# Watch progress:
#   tkn pipelinerun logs -f --last -n <YOUR_NAMESPACE>
#   kubectl get pipelinerun -n <YOUR_NAMESPACE> -w
#
# Trigger with specific branch/tag:
#   kubectl create -f - <<EOF
#   apiVersion: tekton.dev/v1
#   kind: PipelineRun
#   metadata:
#     generateName: gastown-operator-ci-run-
#     namespace: <YOUR_NAMESPACE>
#   spec:
#     pipelineRef:
#       name: gastown-operator-ci
#     params:
#       - name: git-revision
#         value: "feature-branch-name"
#       - name: image-tag
#         value: "feature-branch-name"
#     ...
#   EOF
---
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  generateName: gastown-operator-ci-run-
  # CUSTOMIZE: Set to your CI namespace
  namespace: gastown-ci
  labels:
    app.kubernetes.io/component: pipelinerun
    app.kubernetes.io/name: gastown-operator
  annotations:
    # FedRAMP compliance metadata (optional)
    fedramp.gov/controls: "RA-5,SI-2,CM-14"
spec:
  pipelineRef:
    name: gastown-operator-ci
  params:
    # Git parameters
    - name: git-url
      # CUSTOMIZE: Your git repository URL
      value: "https://github.com/boshu2/gastown-operator.git"
    - name: git-revision
      value: "main"
    # Build parameters
    - name: image-tag
      value: "dev"
    - name: registry
      # CUSTOMIZE: Your container registry
      value: "ghcr.io/boshu2"
    # Security scanning parameters
    - name: trivy-fail-on
      value: "CRITICAL,HIGH"
    - name: generate-sbom
      value: "true"
  taskRunTemplate:
    serviceAccountName: pipeline
  timeouts:
    pipeline: 30m0s
  workspaces:
    # Source code workspace - created dynamically
    - name: source
      volumeClaimTemplate:
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 2Gi
          # CUSTOMIZE: Your StorageClass (or omit for default)
          # storageClassName: standard
    # Registry credentials for image push/pull
    - name: dockerconfig
      secret:
        # CUSTOMIZE: Name of your registry credentials secret
        secretName: registry-credentials
    # Reports workspace (reuses source for simplicity)
    - name: reports
      volumeClaimTemplate:
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 1Gi
