# Gas Town Operator CI PipelineRun Template
# Creates a new pipeline execution for building and scanning the operator
#
# This file uses placeholders that are replaced by GitLab CI:
#   __GIT_URL__      - Repository URL
#   __GIT_REVISION__ - Commit SHA or branch
#   __IMAGE_TAG__    - Image tag (usually commit SHA)
#   __REGISTRY__     - Container registry URL
#
# Prerequisites:
#   1. Apply the Tasks:
#      kubectl apply -f deploy/tekton/tasks/ -n gastown-ci
#
#   2. Apply the Pipeline:
#      kubectl apply -f deploy/tekton/pipeline.yaml -n gastown-ci
#
#   3. Create registry credentials:
#      kubectl create secret docker-registry registry-credentials \
#        --docker-server=<REGISTRY> \
#        --docker-username=xxx --docker-password=xxx -n gastown-ci
#
# Manual Usage (replace placeholders first):
#   kubectl create -f deploy/tekton/pipelinerun.yaml -n gastown-ci
#
# Watch progress:
#   tkn pipelinerun logs -f --last -n gastown-ci
---
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  generateName: gastown-operator-ci-run-
  namespace: gastown-ci
  labels:
    app.kubernetes.io/component: pipelinerun
    app.kubernetes.io/name: gastown-operator
    app.kubernetes.io/part-of: olympus
    tekton.dev/pipeline: gastown-operator-ci
spec:
  pipelineRef:
    name: gastown-operator-ci
  params:
    # Git parameters - replaced by GitLab CI
    - name: git-url
      value: "__GIT_URL__"
    - name: git-revision
      value: "__GIT_REVISION__"
    # Build parameters
    - name: image-tag
      value: "__IMAGE_TAG__"
    - name: registry
      value: "__REGISTRY__"
    # Security scanning
    - name: trivy-fail-on
      value: "CRITICAL,HIGH"
    # envtest version (must match controller-runtime v0.22.x)
    - name: envtest-k8s-version
      value: "1.31.x"
  taskRunTemplate:
    serviceAccountName: pipeline
  timeouts:
    pipeline: 30m0s
  workspaces:
    # Source code workspace
    - name: source
      volumeClaimTemplate:
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 2Gi
    # Registry credentials
    - name: dockerconfig
      secret:
        secretName: registry-credentials
    # Reports workspace
    - name: reports
      volumeClaimTemplate:
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 1Gi
