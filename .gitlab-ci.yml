# ==============================================================================
# GitLab CI/CD for gastown-operator
# ==============================================================================
# Builds container image using Kaniko in olympus-ci namespace (ocppoc cluster).
# No Docker daemon required - runs entirely in-cluster.
#
# Runner: olympus-runner (group: olympus, tags: olympus, openshift, kubernetes)
# Registry: DPR (dprusocplvjmp01.deepsky.lab:5000) for built images
# CI images: From cluster-allowed registries (ghcr.io, gcr.io, quay.io)
# ==============================================================================

stages:
  - lint
  - test
  - build

# ------------------------------------------------------------------------------
# Global Variables
# ------------------------------------------------------------------------------
variables:
  # Go settings
  GOPROXY: "https://proxy.golang.org,direct"
  GOFLAGS: "-mod=readonly"
  CGO_ENABLED: "0"

  # DPR Registry for built images (no auth required for in-cluster access)
  DPR_REGISTRY: "dprusocplvjmp01.deepsky.lab:5000"

  # CI images from cluster-allowed registries
  # Note: DPR is not in OpenShift allowedRegistries, so use public registries
  GO_LINT_IMAGE: "ghcr.io/golangci/golangci-lint:v1.62.2"
  GO_IMAGE: "quay.io/projectquay/golang:1.22"
  KANIKO_IMAGE: "gcr.io/kaniko-project/executor:v1.23.2-debug"

# ------------------------------------------------------------------------------
# Default settings
# ------------------------------------------------------------------------------
default:
  tags:
    - olympus
  retry:
    max: 2
    when:
      - runner_system_failure

# Cache configuration
.go-cache: &go-cache
  cache:
    key: go-${CI_COMMIT_REF_SLUG}
    paths:
      - .cache/go-build
      - .cache/go-mod
    policy: pull-push

# ------------------------------------------------------------------------------
# Lint Stage
# ------------------------------------------------------------------------------
go:lint:
  stage: lint
  image: $GO_LINT_IMAGE
  <<: *go-cache
  variables:
    GOPATH: "$CI_PROJECT_DIR/.cache/go"
    GOCACHE: "$CI_PROJECT_DIR/.cache/go-build"
    GOMODCACHE: "$CI_PROJECT_DIR/.cache/go-mod"
  script:
    - golangci-lint run --timeout 5m
  rules:
    - changes:
        - "**/*.go"
        - go.mod
        - go.sum
        - .gitlab-ci.yml

# ------------------------------------------------------------------------------
# Test Stage
# ------------------------------------------------------------------------------
go:test:
  stage: test
  image: $GO_IMAGE
  <<: *go-cache
  variables:
    GOPATH: "$CI_PROJECT_DIR/.cache/go"
    GOCACHE: "$CI_PROJECT_DIR/.cache/go-build"
    GOMODCACHE: "$CI_PROJECT_DIR/.cache/go-mod"
  script:
    - go test -race -coverprofile=coverage.out ./...
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.out
    expire_in: 1 week
  coverage: '/total:.*\s(\d+(?:\.\d+)?%)$/'
  rules:
    - changes:
        - "**/*.go"
        - go.mod
        - go.sum
        - .gitlab-ci.yml

# ------------------------------------------------------------------------------
# Build Stage - Kaniko (daemonless container builds)
# ------------------------------------------------------------------------------
build:operator:
  stage: build
  image:
    name: $KANIKO_IMAGE
    entrypoint: [""]
  variables:
    # Push to GitLab Container Registry (in cluster allowedRegistries)
    IMAGE_REGISTRY: "${CI_REGISTRY_IMAGE}"
  before_script:
    # Create Docker config for GitLab registry auth
    - mkdir -p /kaniko/.docker
    - |
      AUTH_GL=$(echo -n "${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')
      echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"${AUTH_GL}\"}}}" > /kaniko/.docker/config.json
  script:
    # Kaniko builds without Docker daemon
    - |
      /kaniko/executor \
        --context "${CI_PROJECT_DIR}" \
        --dockerfile "Dockerfile" \
        --destination "${IMAGE_REGISTRY}:${CI_COMMIT_SHA}" \
        --destination "${IMAGE_REGISTRY}:${CI_COMMIT_REF_SLUG}" \
        --destination "${IMAGE_REGISTRY}:latest" \
        --cache=true \
        --cache-repo="${IMAGE_REGISTRY}/cache"
  needs:
    - go:test
  rules:
    # Automatic on main branch
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success
    # Automatic on tags
    - if: '$CI_COMMIT_TAG'
      when: on_success
    # Manual on MRs
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual
      allow_failure: true
    # Manual trigger
    - when: manual
      allow_failure: true
