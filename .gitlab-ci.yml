# gastown-operator CI Pipeline
# Based on fractal pattern - validate locally, build in CI
#
# Lint/complexity: Run locally before push (golangci-lint run)
# CI: test → build → security

variables:
  # DPR Registry (avoids Docker Hub rate limits)
  DPR_REGISTRY: "dprusocplvjmp01.deepsky.lab:5000"

  # CI images (mirrored to DPR via devops/ci-images/mirror-images.sh)
  GO_IMAGE: "${DPR_REGISTRY}/ci-images/golang:1.24-alpine"
  KANIKO_IMAGE: "${DPR_REGISTRY}/ci-images/kaniko:v1.23.2-debug"
  TRIVY_IMAGE: "${DPR_REGISTRY}/ci-images/trivy:latest"

  # Dockerfile base images (passed as build-args)
  BUILD_GO_IMAGE: "${DPR_REGISTRY}/ci-images/golang:1.24-alpine"
  BUILD_DISTROLESS_IMAGE: "${DPR_REGISTRY}/ci-images/distroless-static:nonroot"

  # Go settings
  GOMODCACHE: "$CI_PROJECT_DIR/.go/pkg/mod"
  GOCACHE: "$CI_PROJECT_DIR/.go/cache"

stages:
  - test
  - build
  - security

default:
  interruptible: true
  tags:
    - olympus

cache:
  key: go-cache
  paths:
    - .go/

# ==============================================================================
# TEST STAGE
# ==============================================================================

go:test:
  stage: test
  image: $GO_IMAGE
  script:
    - apk add --no-cache git bash
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
    - go version
    - go mod download
    # Install envtest binaries (etcd, kube-apiserver) for controller tests
    # Pin to release-0.22 branch (matches our controller-runtime v0.22.x)
    - go install sigs.k8s.io/controller-runtime/tools/setup-envtest@release-0.22
    - export PATH="$(go env GOPATH)/bin:$PATH"
    - export KUBEBUILDER_ASSETS="$(setup-envtest use -p path 1.31.x)"
    - go test ./pkg/... ./internal/... -v
  rules:
    - if: '$CI_COMMIT_BRANCH'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# ==============================================================================
# BUILD STAGE - Kaniko (no Docker daemon)
# ==============================================================================

build:operator:
  stage: build
  image:
    name: $KANIKO_IMAGE
    entrypoint: [""]
  variables:
    IMAGE_REGISTRY: "${DPR_REGISTRY}"
    IMAGE_NAME: "gastown-operator"
  before_script:
    - mkdir -p /kaniko/.docker
    - |
      if [ -n "${DPR_USER:-}" ] && [ -n "${DPR_PASSWORD:-}" ]; then
        AUTH=$(echo -n "${DPR_USER}:${DPR_PASSWORD}" | base64 | tr -d '\n')
        echo "{\"auths\":{\"${DPR_REGISTRY}\":{\"auth\":\"${AUTH}\"}}}" > /kaniko/.docker/config.json
      fi
  script:
    - |
      /kaniko/executor \
        --context "${CI_PROJECT_DIR}" \
        --dockerfile "Dockerfile" \
        --destination "${IMAGE_REGISTRY}/${IMAGE_NAME}:${CI_COMMIT_SHA}" \
        --destination "${IMAGE_REGISTRY}/${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}" \
        --destination "${IMAGE_REGISTRY}/${IMAGE_NAME}:latest" \
        --build-arg "GO_IMAGE=${BUILD_GO_IMAGE}" \
        --build-arg "DISTROLESS_IMAGE=${BUILD_DISTROLESS_IMAGE}" \
        --cache=true \
        --cache-repo="${IMAGE_REGISTRY}/${IMAGE_NAME}/cache" \
        --skip-tls-verify-registry="${DPR_REGISTRY}" \
        --insecure-registry="${DPR_REGISTRY}"
  needs:
    - go:test
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual
      allow_failure: true

# ==============================================================================
# SECURITY STAGE - Container scanning
# ==============================================================================

security:trivy:
  stage: security
  image: $TRIVY_IMAGE
  variables:
    TRIVY_NO_PROGRESS: "true"
    TRIVY_CACHE_DIR: "${CI_PROJECT_DIR}/.trivy"
    IMAGE_REGISTRY: "${DPR_REGISTRY}"
    IMAGE_NAME: "gastown-operator"
  cache:
    key: trivy-cache
    paths:
      - .trivy/
  script:
    - trivy --version
    - |
      trivy image \
        --exit-code 0 \
        --severity CRITICAL,HIGH \
        --format table \
        --insecure \
        ${IMAGE_REGISTRY}/${IMAGE_NAME}:${CI_COMMIT_SHA}
  needs:
    - build:operator
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual
      allow_failure: true
  allow_failure: true
