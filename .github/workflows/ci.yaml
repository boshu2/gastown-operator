# Lightweight CI for Community PRs
#
# This workflow runs on pull requests from community contributors.
# ALL builds, releases, and deployments are handled by GitLab/Tekton.
#
# GitHub is a read-only storefront - it receives code and releases
# after everything passes in the GitLab/Tekton pipeline.
#
# What this workflow does:
#   - Runs lint and unit tests on PRs (lightweight validation)
#   - Helps contributors get quick feedback before full CI
#
# What this workflow does NOT do:
#   - Build Docker images
#   - Push to any registry
#   - Create releases
#   - Deploy anything
#
# Full CI/CD flow is documented in .gitlab-ci.yml

name: PR Review

on:
  pull_request:
    branches: [main]

permissions:
  contents: read

env:
  GO_VERSION: '1.24'

jobs:
  # ==========================================================================
  # Lint and Unit Tests (PR validation)
  # ==========================================================================
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run go mod tidy
        run: go mod tidy

      - name: Run go vet
        run: go vet ./...

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest

      - name: Run unit tests
        run: make test

  # ==========================================================================
  # Helm Lint (chart validation)
  # ==========================================================================
  helm-lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Lint Helm chart
        run: |
          helm lint ./helm/gastown-operator
          helm lint ./helm/gastown-operator -f helm/gastown-operator/values-community.yaml
          helm lint ./helm/gastown-operator -f helm/gastown-operator/values-fips.yaml

  # ==========================================================================
  # Generated Code Check
  # ==========================================================================
  validate-generated:
    name: Validate Generated Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Check generated manifests
        run: |
          make manifests
          if ! git diff --exit-code config/; then
            echo "ERROR: Generated manifests are out of date."
            echo "Run 'make manifests' and commit the changes."
            exit 1
          fi

      - name: Check generated code
        run: |
          make generate
          if ! git diff --exit-code api/; then
            echo "ERROR: Generated code is out of date."
            echo "Run 'make generate' and commit the changes."
            exit 1
          fi
